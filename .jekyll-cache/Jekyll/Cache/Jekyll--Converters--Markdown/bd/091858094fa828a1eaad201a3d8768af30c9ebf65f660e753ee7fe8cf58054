I"À*<p>è½¬è½½, å¹¶è®°ä¸‹æˆ‘çš„ä½¿ç”¨å¿ƒå¾—ã€‚</p>

<p>Linux services can be started, stopped and reloaded with the use of scripts stocked in /etc/init.d/.
However, during start up or when changing runlevel, those scripts are searched in /etc/rcX.d/ where X is the runlevel number.
This tutorial will explain how one can activate, deactivate or modify a service start up.
When installing a new service under debian, the default is to enable it. So for instance, if you just installed apache2 package, after you installed it, apache service will be started and so will it be upon the next reboots.
If you do not use apache all the time, you might want to disable this service from starting up upon boot up and simply start it manually when you actually need it by running this command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/apache2 start
</code></pre></div></div>

<p>You could either disable this service on boot up by removing any symbolic links in <strong><em>/etc/rcX.d/SYYapache2</em></strong> or by using <strong>update-rc.d</strong>.
The advantage of using update-rc.d is that it will take care of removing/adding any required links to /etc/init.d automatically.
Taking apache2 as an example, letâ€™s examine how /etc/rcX.d is looking like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ls -l /etc/rc?.d/*apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc0.d/K91apache2 -&gt; ../init.d/apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc1.d/K91apache2 -&gt; ../init.d/apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc2.d/S91apache2 -&gt; ../init.d/apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc3.d/S91apache2 -&gt; ../init.d/apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc4.d/S91apache2 -&gt; ../init.d/apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc5.d/S91apache2 -&gt; ../init.d/apache2
lrwxrwxrwx 1 root root 17 2007-07-05 22:51 /etc/rc6.d/K91apache2 -&gt; ../init.d/apache2
</code></pre></div></div>

<p>As you can see, for runlevels 0, 1 and 6 there is a K at the beginning of the link, for runlevels 2, 3, 4 and 5, there is a S. Those two letters stands for Kill and Start.
On Debian and Ubuntu, runlevels 2, 3, 4 and 5 are multi-users runlevels.
Runlevel 0 is Halt.
Runlevel 1 is single user mode
Runlevel 6 is reboot</p>

<h3 id="1-removing-a-service">1. Removing A Service</h3>

<p>If you want to totally disable apache2 service by hand, you would need to delete every single link in /etc/rcX.d/. Using <strong>update-rc.d</strong> it is as simple as:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-rc.d -f apache2 remove
</code></pre></div></div>
<p>The use of <strong><em>-f</em></strong> is to force the removal of the symlinks even if there is still /etc/init.d/apache2.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Note: This command will only disable the service until next time the service is upgraded. If you want to make sure the service won't be re-enabled upon upgrade, you should also type the following:
    # update-rc.d apache2 stop 80 0 1 2 3 4 5 6 .
</code></pre></div></div>

<h3 id="2-adding-a-service">2. Adding A Service</h3>

<h4 id="21-default-priorities">2.1. Default Priorities</h4>

<p>Now, if you want to re-add this service to be started on boot up, you can simply use:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># update-rc.d apache2 defaults
Adding system startup for /etc/init.d/apache2 ...
/etc/rc0.d/K20apache2 -&gt; ../init.d/apache2
/etc/rc1.d/K20apache2 -&gt; ../init.d/apache2
/etc/rc6.d/K20apache2 -&gt; ../init.d/apache2
/etc/rc2.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc3.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc4.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc5.d/S20apache2 -&gt; ../init.d/apache2
</code></pre></div></div>

<h4 id="22-custom-priorities">2.2. Custom Priorities</h4>

<p>But as you can see, the default value is 20 which is pretty different than 91 â€¦ a S20 link is started before a S91 and and K91 is kill before K20.
To force apache2 to be started with priorities 91 for both Start and Kill, we need to use the following command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># update-rc.d apache2 defaults 91
Adding system startup for /etc/init.d/apache2 ...
/etc/rc0.d/K91apache2 -&gt; ../init.d/apache2
/etc/rc1.d/K91apache2 -&gt; ../init.d/apache2
/etc/rc6.d/K91apache2 -&gt; ../init.d/apache2
/etc/rc2.d/S91apache2 -&gt; ../init.d/apache2
/etc/rc3.d/S91apache2 -&gt; ../init.d/apache2
/etc/rc4.d/S91apache2 -&gt; ../init.d/apache2
/etc/rc5.d/S91apache2 -&gt; ../init.d/apache2
</code></pre></div></div>

<h3 id="23-different-priorities-for-start-and-kill">2.3. Different Priorities For Start And Kill</h3>

<p>Alternatively, if you want to set different priorities for Start than for Kill, let say Start with 20 and Kill with 80, you will need to run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># update-rc.d apache2 defaults 20 80
Adding system startup for /etc/init.d/apache2 ...
/etc/rc0.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc1.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc6.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc2.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc3.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc4.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc5.d/S20apache2 -&gt; ../init.d/apache2
</code></pre></div></div>

<h2 id="3-specifying-custom-runlevels">3. Specifying Custom Runlevels</h2>

<p>Finally, if you only want to Start and Kill on specific runlevels, like for instance starting apache with priority 20 on runlevels 2, 3, 4 and 5 and Kill with priority 80 on runlevels 0, 1 and 6:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># update-rc.d apache2 start 20 2 3 4 5 . stop 80 0 1 6 .
Adding system startup for /etc/init.d/apache2 ...
/etc/rc0.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc1.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc6.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc2.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc3.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc4.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc5.d/S20apache2 -&gt; ../init.d/apache2
</code></pre></div></div>

<p>Or, to start with priority 20 for runlevel 2, 3 and 4 and priority 30 for runlevel 5 and kill with priority 80 for runlevel 0, 1 and 6:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># update-rc.d apache2 start 20 2 3 4 . start 30 5 . stop 80 0 1 6 .
Adding system startup for /etc/init.d/apache2 ...
/etc/rc0.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc1.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc6.d/K80apache2 -&gt; ../init.d/apache2
/etc/rc2.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc3.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc4.d/S20apache2 -&gt; ../init.d/apache2
/etc/rc5.d/S30apache2 -&gt; ../init.d/apache2
</code></pre></div></div>

<h2 id="æˆ‘çš„æ€»ç»“">æˆ‘çš„æ€»ç»“</h2>

<p>é€šè¿‡ update-rc.d æ¥ç®¡ç†Linuxä¸‹å¼€æœºè‡ªåŠ¨è¿è¡Œï¼Œçš„ç¡®å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æˆ‘åœ¨å®é™…éƒ¨ç½²å®è·µä¸­ï¼Œè¿˜æ˜¯é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå¯¼è‡´å¼€æœºåæ²¡æœ‰æ­£å¸¸è‡ªåŠ¨å¯åŠ¨ï¼Œä½†æ˜¯æ‰‹å·¥é€šè¿‡service xxx startå¯ä»¥å¯åŠ¨ã€‚æˆ‘ç»è¿‡æ’æŸ¥å‘ç°ï¼ŒåŸå› æ˜¯åœ¨Linuxç³»ç»Ÿå¯åŠ¨ä¸­ï¼Œåœ¨æ‰§è¡Œ/etc/init.d/ä¸­çš„è„šæœ¬æ—¶ï¼Œæ­¤æ—¶ç³»ç»Ÿæœ‰å¯èƒ½æ²¡æœ‰åŠ è½½å¥½ç³»ç»Ÿä¸­çš„PATHå˜é‡ï¼Œæ‰€ä»¥éœ€è¦åœ¨init.dè„šæœ¬ä¸­æ‰‹å·¥æŒ‡å®šï¼Œå¯¹äºä½¿ç”¨Rubyè„šæœ¬å†™çš„ç¨‹åºï¼Œéœ€è¦GEM_HOME\GEM_PATHç­‰ç¯å¢ƒå˜é‡ï¼Œæˆ‘è¿™é‡Œæ˜¯ç”¨RVMæ¥ç®¡ç†Rubyçš„ï¼Œè¿™æ˜¯æˆ‘ä½¿ç”¨çš„ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PATH="/usr/local/rvm/gems/ruby-1.9.2-p290/bin:/usr/local/rvm/rubies/ruby-1.9.2-p290/bin:/usr/local/rvm/bin:/opt/node/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games"
RUBY_VERSION="ruby-1.9.2-p290"
GEM_HOME="/usr/local/rvm/gems/ruby-1.9.2-p290"
GEM_PATH="/usr/local/rvm/gems/ruby-1.9.2-p290:/usr/local/rvm/gems/ruby-1.9.2-p290@global"
export PATH=$PATH
export RUBY_VERSION=$RUBY_VERSION
export GEM_HOME=$GEM_HOME
export GEM_PATH=$GEM_PATH
</code></pre></div></div>

<p>å¦å¤–è¿˜æœ‰ä¸€äº›å…¶å®ƒçš„å˜é‡ï¼ˆå¦‚æœä½ çš„å¯åŠ¨ç¨‹åºéœ€è¦ï¼‰ï¼Œä¹Ÿéœ€è¦æ‰‹å·¥æŒ‡å®šï¼Œå¦‚åœ¨Ruby 1.9ä¸­ï¼Œå°±æœ‰å¯èƒ½éœ€è¦æŒ‡å®šï¼Œæ¯”å¦‚è¯´unicornå¯åŠ¨è„šæœ¬ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export LANG='en_US.UTF-8'
</code></pre></div></div>

<p>æœ€åé™„ä¸Šä¸€ä¸ªå¸¸ç”¨çš„init.då¯åŠ¨è„šæœ¬çš„æ ·æœ¬ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh
### BEGIN INIT INFO
# Provides:          gps
# Required-Start:    $syslog $remote_fs $network
# Required-Stop:     $syslog $remote_fs $network
# Should-Start:      fam
# Should-Stop:       fam
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start the gps.
### END INIT INFO


PATH=/usr/local/rvm/gems/ruby-1.9.2-p290/bin:/usr/local/rvm/gems/ruby-1.9.2-p290@global/bin:/usr/local/rvm/rubies/ruby-1.9.2-p290/bin:/usr/local/rvm/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
DAEMON=/www/georgia/current/lib/gps/gps.rb
NAME=ntgps
DESC="ntgps daemon"
PIDFILE=/var/run/$NAME.pid
SCRIPTNAME=/etc/init.d/$NAME

DAEMON_OPTS=""

set -e
. /lib/lsb/init-functions
export LANG='en_US.UTF-8'
export PATH=$PATH
export GEM_HOME=/usr/local/rvm/gems/ruby-1.9.2-p290
export GEM_PATH=/usr/local/rvm/gems/ruby-1.9.2-p290:/usr/local/rvm/gems/ruby-1.9.2-p290@global

case "$1" in
    start)
        log_daemon_msg "Starting $DESC" $NAME
        if ! start-stop-daemon --start -m --background --oknodo --quiet --pidfile $PIDFILE --exec /usr/local/rvm/rubies/ruby-1.9.2-p290/bin/ruby $DAEMON -- $DAEMON_OPTS
        then
            log_end_msg 1
        else
            log_end_msg 0
        fi
        ;;
    stop)
        log_daemon_msg "Stopping $DESC" $NAME
        if kill  -9 `cat $PIDFILE`
        then
            rm -f $PIDFILE
            log_end_msg 0
        else
            log_end_msg 1
        fi
        ;;
    restart)
        $0 stop
        $0 start
        ;;
    status)
        status_of_proc -p "$PIDFILE" "$DAEMON" $NAME &amp;&amp; exit 0 || exit $?
        ;;
    *)
        echo "Usage: $SCRIPTNAME {start|stop|restart|status}" &gt;&amp;2
        exit 1
        ;;
esac

exit 0

</code></pre></div></div>

<h2 id="resources">Resources:</h2>
<p><a href="http://www.debuntu.org/how-to-manage-services-with-update-rc.d">How-To: Managing services with update-rc.d</a></p>
:ET